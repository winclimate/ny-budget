---
title: "New York Climate Budget"
author: "Max Shron"
date: "10/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lpSolve)
library(lubridate)
library(units)
```

## Blank slate program design

To start with, we will estimate the amount of subsides we ought to be directing per major clean energy good, independent of the programs which we have, subject to various budget constraints. We will use real empirical data to estimate the demand curves for each of these goods, following the approach laid out in [Climate Budget Optimization Proof of Concept](https://docs.google.com/document/d/1eq0kjtzUI4ryUuUtnjAypdzBlsGi93Nf/edit#).

We will look at subsidies for:

* Rooftop solar
* Heat pumps
* Weatherization
* Electric vehicles
* Charging stations

### Rooftop Solar Subsidies

To start, since we have data on each small-scale solar installation in New York, let's see if we can learn a demand curve and see how good it is.

```{r}
# https://data.ny.gov/Energy-Environment/Solar-Electric-Programs-Reported-by-NYSERDA-Beginn/3x8r-34rs
raw_solar_data <- read_csv("/mnt/data/Solar_Electric_Programs_Reported_by_NYSERDA__Beginning_2000.csv")
fed_solar_tax_credit = tibble(tax_year = 2000:2022, fed_credit = c(replicate(2005-1999, .1), 
                                                               replicate(2020-2005, .3), 
                                                               c(.26, .26)))

solar_data <- raw_solar_data %>%
  mutate(date = mdy(`Date Application Received`),
         tax_year = year(date),
         month = month(date),
         gjgny = ifelse(`Green Jobs Green New York Participant` == "Yes", 1, 0)) %>%
  inner_join(fed_solar_tax_credit, by=c("tax_year")) %>%
  filter(`Total Nameplate kW DC` > 0) %>% # TODO check how bad this is, are we missing a lot of installs? should we impute w/ avg?
  group_by(tax_year) %>%
  summarise(n = n(),
            total_kw = sum(`Total Nameplate kW DC`),
            total_sticker_price = sum(`Project Cost`),
            total_incentive = sum(`$Incentive`, na.rm = TRUE),  # TODO figure out gjgny / other subsidy program impacts too
            fed_credit = mean(fed_credit)) %>%
  mutate(adj_tax_year = tax_year - 2000,
            incentive_per_kw = total_incentive / total_kw,
            sticker_price_per_kw = total_sticker_price / total_kw,
            # TODO understand how many are missing the incentives and if they're meaningful
            total_effective_price = total_sticker_price - total_incentive,
            total_tax_credit = total_effective_price * fed_credit,
            effective_price_per_kw = (total_effective_price - total_tax_credit) / total_kw)
```

Rolled up at the year, let's see what we've got

```{r}
solar_data %>%
  ggplot(aes(x=tax_year, y=incentive_per_kw)) + geom_line()
```
To be honest, not a great instrumental variable, given how closely related it is to year. However, prices per kW themselves have changed drastically, and I believe largely as a result of exogenous technology improvements (as opposed to drops in demand). As a result, I'm comfortable that we can fit a straightforward regression to log(qty) against log(price) and year, instead of a more complex simultaneous estimation of supply and demand curves.

```{r}
solar_data %>% 
  ggplot(aes(x=effective_price_per_kw, y=total_kw)) + geom_smooth() + geom_point()
```

Let's try to fit our simple demand function first:

```{r}
solar.model.1 <- lm(log(total_kw) ~ log(effective_price_per_kw), data = solar_data)
summary(solar.model.1)
```

Not bad, coefficients point in the right directions, are far from zero, and an $R^2$ of 0.69. Let's also fit a linear model and compare that:


```{r}
solar.model.2 <- lm(total_kw ~ effective_price_per_kw, data = solar_data)
summary(solar.model.2)
```

Linear is not great; coefficients point in the right direction, but big drop in $R^2$. 

Finally, let's try the function mentioned earlier, one which includes a demand curve shift based on the log years since the program started in 2000.

```{r}
solar.model.3 <- lm(log(total_kw) ~ log(effective_price_per_kw) + log(adj_tax_year+1), data = solar_data)
summary(solar.model.3)
```
Spectacular! Good looking coefficients and $R^2$ of 0.99. Now to graph all three.

```{r}
qty <- function(X, eta, p) {X * p^(-eta)}

X_solar_kw_loglog = exp(solar.model.1$coefficients[1])
eta_solar_kw_loglog = -solar.model.1$coefficients[2]

b = solar.model.2$coefficients[1]
m = solar.model.2$coefficients[2]

model.3.preds <- tibble(price = seq(600,5000, length.out=100),
                        logqty = predict(solar.model.3, list(adj_tax_year=replicate(100,23), effective_price_per_kw=price)),
                        qty = exp(logqty))

qty_solar <- function(p) {predict(solar.model.3, list(adj_tax_year=replicate(length(p), 23), effective_price_per_kw=p)) %>% exp}
                                                          
historical_min_price = min(solar_data$effective_price_per_kw)
most_recent = last(solar_data$effective_price_per_kw)

solar_data %>% 
  ggplot(aes(x=effective_price_per_kw, y=total_kw, label = tax_year)) +
  #geom_function(fun = ~qty(X_solar_kw, eta_solar_kw, .x), 
  #              xlim=c(historical_min_price*(0.8), historical_min_price*(2)), color='red') +
  geom_function(fun = ~ m *.x + b, 
                xlim=c(historical_min_price*(0.8), historical_min_price*(3)), color='blue') +
  geom_function(fun = ~ (qty_solar(.x)),
                xlim=c(historical_min_price*(0.8), historical_min_price*(3)), color='green') +
  geom_point() + geom_label() +
  xlim(c(historical_min_price*(0.8), historical_min_price*3)) + 
  xlab("Price / kW") +
  ylab("Qty kW")
```

Red is the original demand function I sought to fit (log-log), blue is a linear function, and green is a log-log function with a log(year) based demand shift parameter. The third (green) model is great; as mentioned before, it's got a 0.98 $R^2$, the parameters all point in the right direction, the standard errors are all far from zero, and fits our general functional goals. '

I'm going to declare that one the winner. The only reason it doesn't look like it's bang on in the graph is because I'm drawing the predictions for `year=2023`, not the years that the data were actually collected.

Next we need to calculate how many kg of CO2e are saved per kW installed per year.

```{r}
# Total electricity generation NYS is 28.7 billion kWh (https://www.nypa.gov/power/generation/generation-overview)
ny_energy_total <- as_units(28.7e9, 'kW*h')

# Total mmtCO2e GWP20 for energy generation in-state (https://www.dec.ny.gov/docs/administration_pdf/ghgsumrpt21.pdf)
ny_energy_ghg <- as_units(50.64e9, 'kg')

# Hours of sunlight per year (https://www.solardirect.com/archives/pv/systems/gts/gts-sizing-sun-hours.html)
# averaged over the five example cities
ny_sunlight_annual_hrs <- as_units(3.5*365, 'hr/year')

g_solar_kwh <- ny_energy_ghg / ny_energy_total # ignoring out-of-state energy and GHG effects of the panels themselves

g_solar <- g_solar_kwh * ny_sunlight_annual_hrs
g_solar
```

Finally for this one, let's look at different possible subsidy levels:

```{r}
p_solar_base <- 1000

qty_solar <- function(p) {
    solar.model.3 %>%
    predict(list(adj_tax_year=replicate(length(p), 23), effective_price_per_kw=p)) %>% 
    exp %>%
    as_units("kW*h")
}

s_solar <- tibble(subsidy_kwh = seq(0, p_solar_base * 0.8, length.out = 50),
                  qty_no_subsidy = qty_solar(p_solar_base),
                  qty_w_subsidy = qty_solar(p_solar_base - subsidy_kwh),
                  incremental_qty = qty_w_subsidy - qty_no_subsidy,
                  ghg_saved = g_solar * incremental_qty)

s_solar %>%
  ggplot(aes(x = subsidy_kwh, y = ghg_saved)) +
  geom_line() +
  xlim(c(0, p_solar_base*.8)) +
  xlab("Subsidy ($/kW)") +
  ylab("CO2 reduction")
```

### Heat Pump Subsidies

We can get per-year data, average heat pump prices. Redo everything into BTUs to account for wide variety of homes. Have prices been changing year on year for heat pumps?

### Weatherization Subsidies

What drives the purchase of weatherization, besides buying a heat pump?

### EV Subsidies

Let's start by looking at the EV data from NYSERDA

```{r}
# https://data.ny.gov/Energy-Environment/NYSERDA-Electric-Vehicle-Drive-Clean-Rebate-Data-B/thd2-fu8y
raw_ev_data <- read_csv("/mnt/data/NYSERDA_Electric_Vehicle_Drive_Clean_Rebate_Data__Beginning_2017.csv")

raw_ev_data
```

Some immediate issues:
* Doesn't contain the cost of the car itself. Do we need to join that in? Or can we build an analysis just based on the subsidy amount?
* I think we need the Federal tax subsidy just like we have for rooftop solar
* Does the fact that there is a clear substitute good (gasoline cars) change how we do this analysis?

Some EDA

```{r}
raw_ev_data %>%
  mutate(submitted_date = mdy(`Submitted Date`),
         Year = year(submitted_date)) %>%
  group_by(Year) %>%
  summarise(n = n(),
            total_ghg = sum(`Annual GHG Emissions Reductions (MT CO2e)`),
            total_rebate = sum(`Rebate Amount (USD)`, na.rm = TRUE),
            dollars_per_rebate = total_rebate/n)
```

Load car price data

```{r}
# https://www.teoalida.com/cardatabase/year-make-model-trim-specs/
# Purchased the electric/hybrid dataset for $83 on 10/11/2022, sent to max@polynumeral.com
teoalida <- read_csv("/mnt/data/Year-Make-Model-Trim-Full-Specs-electric-hybrid-only-by-Teoalida.csv")

car_prices <- teoalida %>% 
  mutate(price = parse_number(`Base MSRP`)) %>%
  filter(Year >= 2017) %>%
  group_by(Make, Model, Year) %>%
  summarise(msrp = mean(price, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(model_lower = tolower(Model),
         model_lower = str_replace(model_lower, "bolt .*", "bolt"), # bolt euv / bolt ev -> bolt
         model_lower = str_replace(model_lower, "crosstrek", "crosstrek phev"), # crosstrek -> crosstrek phev (no other option!)
         model_lower = str_replace(model_lower, "ioniq", "ionic"), # state ev data is wrong, but they need to match
         model_lower = str_replace(model_lower, "optima plug-in hybrid", "optima plug-in")) %>%
  select(-Model)

car_prices
```

```{r}
car_prices %>% 
  ggplot(aes(x=msrp)) +
  geom_histogram()
```
```{r}
ev_data <- raw_ev_data %>%
  mutate(submitted_date = mdy(`Submitted Date`),
         Year = year(submitted_date),
         model_lower = tolower(Model)) %>%
  left_join(car_prices, by=c('Make','model_lower','Year')) # nb calendar year != make year, but close enough

# Coverage?
1-mean(is.na(ev_data$msrp)*1.)
```

Thoughts:
* From the EPA combined mileage, we could calculate the average yearly cost to fuel each car, and similar for maintenance from some third party source; do we need that kind of cross elasticity estimate to get a good demand function? 
  * No, I think just using gas prices as a demand shifter is probably enough, so we need annual average gas prices
  * Do we separate into low, mid, lux tiers and estimate from there?
  
Separate into low, mid, lux. Calculate 5-year TCO. Subtract subsidies (state and federal). Fit model to log(qty) vs log(total price) + log(gas).

### Chaging Station Subsidies

Where is there data on this?
